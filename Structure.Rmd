---
title: "Structural Descriptive Statistics"
author: "DakaraiMcCoy"
date: "8/28/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Import data
```{r import data}
# Use R to get a list of files 
wave1 <- list.files(path = "/Volumes/SocialDevelopmentProject/fMRI/BrainSuite/Stats/wave1", pattern = "*.txt", full.names = TRUE)
# Create list of data frames
myfiles = lapply(wave1,read.delim)

```





## Clean data - At a later point generalize to full data set
```{r, clean data}
       
# In each data frame, create a subset data frame for the ROI and the measurments of interest. 
# Get Insula ROI's
myfiles.ROI <-lapply(myfiles, function(x) {subset.data.frame(x =x, subset = ROI_ID >= 500 & ROI_ID < 600, select = c(ROI_ID,Mean_Thickness.mm.,GM_Volume.mm.3.,WM_Volume.mm.3.))})

# Melt the data to create a long data frame suitable for casting 
library(reshape2)

# Data is formatted so that each id.vars are the variables measured in each ROI, which is the measurment variable with values equal to the regoin of interest.
myfiles.long <- melt(data = myfiles.ROI, 
                     id.vars = c("Mean_Thickness.mm.", "GM_Volume.mm.3.", "WM_Volume.mm.3."),
                     measure.vars = "ROI_ID", 
                     value.name = "ROI")

# Make sure the ROI's are categrical.
myfiles.long$ROI <- myfiles.long$ROI <- as.factor(myfiles.long$ROI)

# Separate the hemispheres
myfiles.long$hemisphere <- ifelse(myfiles.long$ROI %in% c("500", "510", "520", "530"), 
                            "right", "left")
myfiles.long$region <- substr(myfiles.long$ROI, 1, 2)

# Create a region label
myfiles.long$region <- factor(myfiles.long$region, 
                              labels = c("Insula", "dA-Insula", "vA-Insula", "post-Insula"))
str(myfiles.long)

```

## Get Descriptive Statistics


```{r}
## Null Hypothesis is that there is no group difference in mean cortical thickness. alternative Hypothesis is that there is a group difference in mean cortical thickness. 

## Null Hypothesis is that there is no difference of the mean cortical thickness between the two groups of students. Alternative hypothesis is that there is a difference of the mean cortical thickness between the two groups of students. 
library(ggplot2)

# Show box plot of mean cortical thickness in each ROI
p <- ggplot(myfiles.long, mapping = aes(y = Mean_Thickness.mm.)) +
             geom_boxplot() +
             geom_jitter(aes(x = 0), width = 0.1, height = 0, 
                         size = .3) +   # add a plot layer with points
             facet_grid(region ~ hemisphere, scales = "free") +
             coord_flip()
  
show(p)

# Show box plot of WM Volume in each ROI
p <- ggplot(myfiles.long, mapping = aes(y = WM_Volume.mm.3.)) +
             geom_boxplot() +
             geom_jitter(aes(x = 0), width = 0.1, height = 0, 
                         size = .3) +   # add a plot layer with points
             facet_grid(region ~ hemisphere, scales = "free") + 
             coord_flip()
show(p)

# Show box plot of GM Volume in each ROI
p <- ggplot(myfiles.long, mapping = aes(y = GM_Volume.mm.3.)) +
             geom_boxplot() + 
             geom_jitter( aes(x = 0), width = 0.1, height = 0, 
                         size = .3) +   # add a plot layer with points
                                        # position = position_jitter(width = 0.1), 
             facet_grid(region ~ hemisphere , scales = "free") + 
             coord_flip()
show(p)
```
I need to check which subjects are outliers and which subjects are outliers in each region. It appears as though there may be a functional-structure relationship in these areas of the brain. Questions from lab meeting are: Are these brain regions actually measures we can use? Are they representative of the population and can we say these range of values is acceptable for developing adolescents? 


## Create a dataframe for each ROI and each region and then compute outliers.
# use reshape from stats package. This is designed to convert data to a wide format when it is listed in a long format. 
```{r boxplots}

# Calculate statsitics for just the few ROI's of interest primarily in the Insula. 

## TO DO> Build this tool to become a part of the R statistics toolbox. Use this tool to allow the user to select which statistics they wish to run and on which tools. These tools here will allow the user to take statitistics from BrainSuite. 
library(stats)
myfiles.wide <- stats::reshape(data = myfiles.long, 
                               direction = "wide", 
                               timevar = "ROI", 
                               idvar = "L1", 
                               drop = c("variable","region","hemisphere")
                               )
str(myfiles.wide)
mt <- myfiles.wide[seq(from = 2, to = length(myfiles.wide), by = 3)]
gm <- myfiles.wide[seq(from = 3, to = length(myfiles.wide), by = 3)]
wm <- myfiles.wide[seq(from = 4, to = length(myfiles.wide), by = 3)]

gm.boxplot <- boxplot(gm)
mt.boxplot <- boxplot(mt)
wm.boxplot <- boxplot(wm)
```

``` {r outliers}
# outliers for GM
# Doesnt quite work yet. But it should work
# get_outlier_subjects <- function(data,outliers) {
#   out <- c()
#   for (i in 1:ncol(data)){
#     out <- as.list(out,data.frame(outliers_i = match(signif(outliers$out[outliers$group == i], 7),
#                                                        signif(data[,i], 7))))
#     
#     #out <- rbind(out,
#     #             subs <- data.frame(outliers_i = match(signif(outliers$out[outliers$group == i], 7),
#     #                                                   signif(data[,i], 7))))
#   }
#   }
# 
# 
# Gm <- get_outlier_subjects(gm,gm.boxplot)
# Mt <- get_outlier_subjects(mt,mt.boxplot)
# Wm <- get_outlier_subjects(wm,wm.boxplot)

# outliers for MT
GM <- c()
for (i in 1:ncol(gm)){
GM <- rbind(GM,
              sub1 <- data.frame(outliers_ind = match(signif(gm.boxplot$out[gm.boxplot$group == i], 7),
                                                       signif(gm[,i], 7))))
}
GM$group = gm.boxplot$group
# outliers for MT
MT <- c()
for (i in 1:ncol(mt)){ 
  MT <- rbind(MT,
              sub1 <- data.frame(outliers_ind = match(signif(mt.boxplot$out[mt.boxplot$group == i], 7),
                                                    signif(mt[,i], 7))))
}
MT$group = mt.boxplot$group

# outliers for WM
WM <- c()
for (i in 1:ncol(wm)){ 
  WM <- rbind(WM, 
              sub1 <- data.frame(outliers_ind = match(signif(wm.boxplot$out[wm.boxplot$group == i], 7),
                                                    signif(wm[,i], 7))))
}
WM$group = wm.boxplot$group

# Get all of the outliers that are in each group. If a subject has an outlier in all three methods, That gives me reason to investigate what it happening with these subjects structural maps and segmentation. 
outliers.common <- intersect(intersect(unique(GM$outliers_ind),unique(WM$outliers_ind)),unique(MT$outliers_i))

#Check all the outliers that are in the same ROI.
  outliers.group = c()
  for (i in 1:ncol(gm)){
   outliers.group <- data.frame(intersect(intersect(WM$outliers_ind[WM$group == i],
                                                    GM$outliers_ind[GM$group==i]),
                                          MT$outliers_i[MT$group == i]))
  }
  outliers.group
  # Therer are no outliers common in each group. 
  
  # Find the max and min of each group outlier. Group 7 ROI - Right post Insula 
rPI_min <-match(signif(gm.boxplot$out[gm.boxplot$group == 7], 7),
      signif(gm[,7], 7))[which.min(gm.boxplot$out[gm.boxplot$group ==7])]
# [1] 14
rPI_max <- match(signif(gm.boxplot$out[gm.boxplot$group == 7], 7),
      signif(gm[,7], 7))[which.max(gm.boxplot$out[gm.boxplot$group ==7])]
#[1] 20
# GM Group 1 outliers - right Insula
rI_min <- match(signif(gm.boxplot$out[gm.boxplot$group == 1], 7),
      signif(gm[,1], 7))[which.min(gm.boxplot$out[gm.boxplot$group ==1])]
# [1] 48
rI_max <- match(signif(gm.boxplot$out[gm.boxplot$group == 1], 7),
      signif(gm[,1], 7))[which.max(gm.boxplot$out[gm.boxplot$group ==1])]
#[1] 8
# GM Group 2 outliers - left Insula
lI_min <- match(signif(gm.boxplot$out[gm.boxplot$group == 2], 7),
      signif(gm[,2], 7))[which.min(gm.boxplot$out[gm.boxplot$group ==2])]
# [1] 7
lI_max <- match(signif(gm.boxplot$out[gm.boxplot$group == 2], 7),
      signif(gm[,2], 7))[which.max(gm.boxplot$out[gm.boxplot$group ==2])]
#[1] 35



  
```

## Read Participant information excel sheet and format to join with other data types. 
```{r}
library(tidyverse)
# Load participant information
ses_df <- readxl::read_xlsx("Participant_info.xlsx")

# Get subjects that are in both timepoints
subject_to_load <- ses_df %>% 
  mutate(wave1_data = file.exists(paste0("/Volumes/SocialDevelopmentProject/fMRI/BrainSuite/Stats/wave1/sub", `Subject #`, "-anat.roiwise.stats.txt")), 
         wave2_data = file.exists(paste0("/Volumes/SocialDevelopmentProject/fMRI/BrainSuite/Stats/wave2/", `Subject #`, "_T1w_1m.roiwise.stats.txt"))) %>% 
  filter(wave1_data, wave2_data) %>% 
  pull(`Subject #`) 

# Get information for subjects that are in both timepoints
participant_info <- ses_df %>% 
  mutate(wave1_data = file.exists(paste0("/Volumes/SocialDevelopmentProject/fMRI/BrainSuite/Stats/wave1/sub", `Subject #`, "-anat.roiwise.stats.txt")), 
         wave2_data = file.exists(paste0("/Volumes/SocialDevelopmentProject/fMRI/BrainSuite/Stats/wave2/", `Subject #`, "_T1w_1m.roiwise.stats.txt"))) %>% 
  filter(wave1_data, wave2_data) %>%
  select(subject = `Subject #`, culture = starts_with("culture"), 
         gender = starts_with("gender"), starts_with("age")) %>%
  rename(age1 = "age at wave 1", age2 = "age at wave 2")

  

wave2 <- list.files(path = "/Volumes/SocialDevelopmentProject/fMRI/BrainSuite/Stats/wave2", 
                    pattern = "*.txt", 
                    full.names = TRUE)

# Match subjects ID's to order of subjects in wave1
matches1 <- lapply(ses_df$`Subject #`, function(x) grep(x, wave1, fixed = TRUE))

matches2 <- lapply(ses_df$`Subject #`, function(x) grep(x, wave2, fixed = TRUE))

# get subject index to get subjects in common for longitudinal analysis
ind2 <- as.logical(lapply(matches2, function(x) {!identical(x,integer(0))}))
ind1 <- as.logical(lapply(matches1, function(x) {!identical(x,integer(0))}))
common <- ind1 & ind2
```

```{r}
# Code written by mark using tidyverse package to get data into wide format. 
# This code gets wave 1 data into the wide format using the same subjects that are in wave 2 as well.
combine_df <- map_df(subject_to_load, 
                     ~ read.delim(paste0("/Volumes/SocialDevelopmentProject/fMRI/BrainSuite/Stats/wave1/sub", .x, "-anat.roiwise.stats.txt")) %>% 
                       mutate(subject = .x)) 
combined <- combine_df %>% 
  mutate(total_Vol = GM_Volume.mm.3. + WM_Volume.mm.3. + CSF_Volume.mm.3.) %>%
  select(subject, ROI_ID, Mean_Thickness.mm., GM_Volume.mm.3., 
         WM_Volume.mm.3., CSF_Volume.mm.3., total_Vol ) %>% 
  filter(ROI_ID >= 500 & ROI_ID < 600) %>%
  mutate_at(c("GM_Volume.mm.3.", "WM_Volume.mm.3.", "CSF_Volume.mm.3."), 
            ~./total_Vol) %>%
  select(subject, ROI_ID, Mean_Thickness.mm., GM_Volume.mm.3., WM_Volume.mm.3., CSF_Volume.mm.3.) %>%
  gather(key = "var", value = "value", 3:6) %>% 
  #mutate()  %>%   # recode ROI_ID
  unite("var_combined", ROI_ID, var) %>% 
  spread(var_combined, value)  

# Now add wave 2 to the data set. 
```

## Plot statistics using sex, and age to see trends
```{r}
# Plot the ROI's by age and sex. 
  

```

## Diagnostic tools to check if all assumptions are met for each type of  

